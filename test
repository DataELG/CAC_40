import logging
from utils.fetch_functions import *
from utils.bdd_functions import *
from utils.req_functions import *
from utils.email_functions import *
from utils.date_functions import *
from datetime import date
    
   # Delare sessions
session_companies_table, companies_table, engine = create_session('COMPANIES')
session_streaming_table, streaming_table, engine = create_session('STREAMING')

# 3 - Get data every 10 mins 
list_cac40_cie = fetch_active_CAC40_cie(companies_table,session_companies_table)
for boursorama_cie_ID in list_cac40_cie :
    key_id = get_id(companies_table,boursorama_cie_ID,session_companies_table)
    data = fetch_streaming_data(boursorama_cie_ID)
    exists = session_streaming_table.query(streaming_table).filter_by(COMPANIE_ID=key_id, DATE=data['Day']).first()
    if exists is None:
        insert_streaming(streaming_table,session_streaming_table,key_id, data)
    
    session_companies_table.close() 
    session_streaming_table.close()
    